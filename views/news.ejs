<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Your existing head content (meta, css, adsense, etc.) -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>News & Updates - MySchoolResult</title>
  <meta name="description" content="Latest news, announcements, and educational updates from MySchoolResult...">
  <link rel="canonical" href="https://myschoolresult.com/news">
 <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2077324357254940"
     crossorigin="anonymous"></script>
  <link rel="stylesheet" href="/styles/index.css">
  <link rel="stylesheet" href="/styles/news.css">
</head>
<body>
  <%- include('partials/header2') %>

  <section class="hero">
    <div class="container">
      <h1>News & Updates</h1>
      <p>Stay informed with the latest announcements, feature releases, partnerships, and inspiring student success stories from MySchoolResult.</p>
    </div>
  </section>

  <section class="news-section">
    <div class="container">
      <div class="filters">
        <button class="filter-btn active" data-filter="all">All News</button>
        <button class="filter-btn" data-filter="education">Education</button>
        <button class="filter-btn" data-filter="exams">Exams</button>
        <button class="filter-btn" data-filter="schools">Schools</button>
        <button class="filter-btn" data-filter="students">Students</button>
      </div>

      <!-- Featured News - Rendered Server-Side -->
      <% if (featuredArticle) { %>
        <article class="featured-news">
          <div class="featured-image"  style="background-image: url('<%= featuredArticle.image || featuredArticle.urlToImage || featuredArticle.image_url %>')">></div>
          <div class="featured-content">
            <span class="news-badge featured-badge">Featured</span>
            <h2 class="featured-title"><%= featuredArticle.title || "Featured News" %></h2>
            <p style="margin-bottom:1.5rem;color:var(--gray);">
              <%= (featuredArticle.description || "").substring(0, 150) %>...
            </p>
            <div class="news-meta">
              <span>üóìÔ∏è <%= new Date(featuredArticle.pubDate || featuredArticle.dateTime).toLocaleDateString() %></span>
              <span>‚úçÔ∏è <%= Array.isArray(featuredArticle.creator) ? featuredArticle.creator[0] : featuredArticle.creator || "MySchoolResult" %></span>
            </div>
            <a href="/news_details/<%=featuredArticle._id %>" 
               class="read-more" 
               data-article-index="<%=featuredArticle._id %>">
              Read Full Story
            </a>
          </div>
        </article>
      <% } %>

      <!-- News Grid - First 9 rendered server-side -->
      <div class="news-grid">
        <% if (articles.length === 0 && !featuredArticle) { %>
          <p style="text-align: center; padding: 3rem;">No news available at the moment. Check back soon!</p>
        <% } else { %>
          <% articles.forEach((article, i) => { %>
            <% const globalIndex = allArticlesForJS.indexOf(article); %>
            <article class="news-card" data-category="<%= (article.category || 'education').toLowerCase() %>">
              <img src="<%= article.image || 'https://via.placeholder.com/400x250?text=School+News' %>" 
                   alt="<%= article.title %>" class="news-image" />
              <div class="news-content">
                <h3><%= article.title || "Untitled Article" %></h3>
                <p><%= (article.description || "").substring(0, 150) %>...</p>
                <p class="news-meta">
                  üóìÔ∏è <%= new Date(article.pubDate || article.dateTime).toLocaleDateString() %> | 
                  ‚úçÔ∏è <%= Array.isArray(article.creator) ? article.creator[0] : article.creator || "MySchoolResult" %>
                </p>
                <a href="/news_details/<%= article._id %>" 
                   class="news-link" 
                   data-article-index="<%= globalIndex %>">Read More</a>
              </div>
            </article>
          <% }); %>
        <% } %>

        <div id="loading-spinner" style="display: none; text-align: center; padding: 2rem;">
          
        </div>
        <div id="sentinel"></div>
      </div>

      <!-- Newsletter -->
      <div class="newsletter">
        <h3>Never Miss an Update</h3>
        <p>Subscribe to our newsletter for exclusive feature announcements, success stories, and education insights delivered monthly.</p>
        <form class="newsletter-form">
          <input type="email" class="newsletter-input" placeholder="Enter your email" required>
          <button type="submit" class="newsletter-btn">Subscribe</button>
        </form>
      </div>
    </div>
  </section>

  <%- include('partials/footer') %>

  <!-- Keep minimal JS for infinite scroll, filtering, and caching -->
  <script>
    // Pass full initial articles to JS (for infinite scroll & click caching)
    window.__INITIAL_ARTICLES = <%- JSON.stringify(allArticlesForJS) %>

    let allArticles = window.__INITIAL_ARTICLES || [];
    let currentPage = 1;
    let hasMore = allArticles.length >= 9; // If we got 9, likely more exist
    let isLoading = false;
    let currentFilter = "all";
    const PAGE_SIZE = 9;
    const API_BASE = "/api/news/scrolling";

    const newsGrid = document.querySelector(".news-grid");
    const loadingEl = document.getElementById("loading-spinner");

    // Helper: create card (same as before)
    function createCard(article, index) {
      const desc = (article.description || "").substring(0, 150) + (article.description?.length > 150 ? "..." : "");
      const date = new Date(article.pubDate || article.dateTime).toLocaleDateString();
      const author = Array.isArray(article.creator) ? article.creator[0] : article.creator || "MySchoolResult";
      const image = article.image || "https://via.placeholder.com/400x250?text=School+News";

      return `
        <article class="news-card" data-category="${(article.category || 'education').toLowerCase()}">
          <img src="${image}" alt="${article.title}" class="news-image" />
          <div class="news-content">
            <h3>${article.title || "Untitled"}</h3>
            <p>${desc}</p>
            <p class="news-meta">üóìÔ∏è ${date} | ‚úçÔ∏è ${author}</p>
            <a href="/news_details/${article._id}" class="news-link" data-article-index="${index}">Read More</a>
          </div>
        </article>
      `;
    }

    // Infinite scroll fetch & append
    async function loadMore() {
      if (isLoading || !hasMore) return;
      isLoading = true;
      loadingEl.style.display = "none";

      try {
        currentPage++;
        const params = new URLSearchParams({ page: currentPage, limit: PAGE_SIZE });
        const res = await fetch(`${API_BASE}?${params}`);
        const data = await res.json();
        const newArticles = data.articles || [];

        newArticles.forEach((article, i) => {
          const globalIndex = allArticles.length;
          allArticles.push(article);
          newsGrid.insertAdjacentHTML("beforeend", createCard(article, globalIndex));
        });

        hasMore = newArticles.length === PAGE_SIZE;
      } catch (err) {
        console.error(err);
      } finally {
        isLoading = false;
        loadingEl.style.display = "none";
      }
    }

    // Setup infinite scroll
    const observer = new IntersectionObserver(entries => {
      if (entries[0].isIntersecting && hasMore && !isLoading) {
        loadMore();
      }
    }, { threshold: 0.1 });

    observer.observe(document.getElementById("sentinel"));

    // Cache on click
    document.addEventListener("click", e => {
      const link = e.target.closest("a[data-article-index]");
      if (!link) return;
      const index = parseInt(link.dataset.articleIndex);
      const article = allArticles[index];
      if (article) {
        localStorage.setItem(`selectedArticle_${index}`, JSON.stringify(article));
      }
    });
  </script>
</body>
</html>